<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Create Your Page</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 20px; }
    h1 { color: #333; }
    label { display: block; margin-top: 15px; }
    input, textarea { width: 100%; padding: 10px; margin-top: 5px; }
    button { margin-top: 15px; padding: 10px 20px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }
    button:disabled { background-color: #aaa; cursor: not-allowed; }
    #auth-status { margin-top: 10px; font-weight: bold; color: green; }
  </style>
</head>
<body>
  <h1>Add your web page!</h1>

  <form id="authForm">
    <label>Username:</label>
    <input type="text" id="username" required />

    <label>Password:</label>
    <input type="password" id="password" required />

    <button type="submit" id="loginButton">Login</button>
    <div id="auth-status"></div>
  </form>

  <hr>

  <form id="pageForm">
    <label>Page Title:</label>
    <textarea id="title" rows="1" required></textarea>

    <label>Page Content:</label>
    <textarea id="description" rows="4" required></textarea>

    <label>Optional Image:</label>
    <input type="file" id="image" accept="image/*" />

    <button type="submit" id="submitButton" disabled>Submit Page</button>
  </form>

  <script>
    let authToken = null;

    document.getElementById("authForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;

      const loginRes = await fetch('/login', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ username, password })
      });

      const authStatus = document.getElementById("auth-status");
      if (!loginRes.ok) {
        authToken = null;
        authStatus.textContent = "Login failed.";
        authStatus.style.color = "red";
        document.getElementById("submitButton").disabled = false;
        return;
      }

      const data = await loginRes.json();
      if (data.token) {
        authToken = data.token;
        authStatus.textContent = "Logged in.";
        authStatus.style.color = "green";
        document.getElementById("submitButton").disabled = false;
      } else {
        authStatus.textContent = "Login failed: token missing.";
        authStatus.style.color = "red";
        document.getElementById("submitButton").disabled = false;
      }
    });

    document.getElementById("pageForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      // if (!authToken) {
      //   alert("You must login first.");
      //   return;
      // }

      const title = document.getElementById("title").value;
      const description = document.getElementById("description").value;
      const imageFile = document.getElementById("image").files[0];

      function sendPage(htmlContent) {
        fetch('/upload', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({ title: title, html: htmlContent })
        })
        .then(res => {
          if (res.ok) {
            alert("Page submitted successfully!");
          } else {
            alert("Failed to submit page.");
          }
        })
        .catch(() => alert("Network error during page submission."));
      }

      if (imageFile) {
        const reader = new FileReader();
        reader.onload = function () {
          const imageTag = `<img src="${reader.result}" style="max-width:100%;" />`;
          const htmlContent = `
            <h1>${title}</h1>
            <h2>Lore</h2>
            <p>${description}</p>
            <h2>Image</h2>
            ${imageTag}
          `;
          sendPage(htmlContent);
        };
        reader.readAsDataURL(imageFile);
      } else {
        const htmlContent = `
          <h1>${title}</h1>
          <h2>Lore</h2>
          <p>${description}</p>
          <h2>Image</h2>
          <p>No image provided.</p>
        `;
        sendPage(htmlContent);
      }
    });
  </script>
</body>
</html>
